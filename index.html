<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KMZ Processor</title>
<style>
  :root { --primary:#0b57d0; --muted:#667085; --bg:#f7f7fb; }
  body { font-family: system-ui, Arial, sans-serif; max-width: 760px; margin: 40px auto; padding: 0 16px; }
  h1 { margin: 0 0 8px; }
  .card { background:#fff; border:1px solid #e6e8eb; border-radius: 14px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.03) }
  .row { display:flex; gap: 12px; align-items:center; flex-wrap:wrap; }
  input[type="file"]{ max-width:100% }
  button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer }
  .primary { background:var(--primary); color:#fff }
  .ghost { background:#eef3ff; color:#0b57d0 }
  .danger { background:#ef4444; color:#fff }
  .muted { color: var(--muted); font-size: 14px }
  .mt8 { margin-top:8px }
  .progress { position:relative; height:12px; background:#eef0f3; border-radius:999px; overflow:hidden }
  .bar { height:100%; width:0%; background:var(--primary); transition: width .15s ease }
  .bar.indeterminate { position: absolute; width:40%; left:-40%; animation: ind 1.2s infinite linear; }
  @keyframes ind { from { left:-40% } to { left:100% } }
  pre { background: #fbfbfd; border:1px solid #eee; border-radius:10px; padding:10px; overflow:auto }
</style>
</head>
<body>
  <h1>KMZ Processor</h1>
  <p class="muted">Sube tu <b>TEST.kmz</b> (o <b>TEST.kml</b>). Verás el progreso de subida, procesamiento y descarga.</p>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept=".kmz,.kml" />
      <button id="btn" class="primary">Procesar</button>
      <button id="cancel" class="danger" disabled>Cancelar</button>
    </div>

    <!-- Progreso de subida -->
    <div class="mt8">Subiendo: <span id="upPct">0%</span></div>
    <div class="progress"><div id="upBar" class="bar"></div></div>

    <!-- Progreso de procesamiento (indeterminado) -->
    <div class="mt8">Procesando en servidor:</div>
    <div class="progress"><div id="procBar" class="bar indeterminate"></div></div>

    <!-- Progreso de descarga -->
    <div class="mt8">Descargando: <span id="downPct">0%</span></div>
    <div class="progress"><div id="downBar" class="bar"></div></div>

    <div id="status" class="muted mt8"></div>
    <pre id="log" class="mt8" style="display:none"></pre>
  </div>

<script>
const RUN_URL = "https://kmz-processor-411960240345.us-central1.run.app";

const $file = document.getElementById("file");
const $btn = document.getElementById("btn");
const $cancel = document.getElementById("cancel");
const $status = document.getElementById("status");
const $log = document.getElementById("log");
const upBar = document.getElementById("upBar");
const procBar = document.getElementById("procBar");
const downBar = document.getElementById("downBar");
const upPct = document.getElementById("upPct");
const downPct = document.getElementById("downPct");

let xhr = null;

function resetBars(){
  upBar.style.width = "0%"; upPct.textContent="0%";
  downBar.style.width = "0%"; downPct.textContent="0%";
  // Procesamiento indeterminado apagado por defecto; lo encendemos al empezar
  procBar.style.display = "none";
}
resetBars();

function setStatus(msg){ $status.textContent = msg; }
function setError(msg, details=""){
  $status.textContent = "❌ " + msg;
  if(details){
    $log.style.display = "block";
    $log.textContent = details;
  }
}

$cancel.onclick = () => { if (xhr) { xhr.abort(); setStatus("Operación cancelada."); $cancel.disabled = true; $btn.disabled = false; } };

$btn.onclick = () => {
  const f = $file.files[0];
  if(!f){ alert("Selecciona un archivo .kmz o .kml"); return; }
  if(!/\.(kmz|kml)$/i.test(f.name)){ alert("Archivo inválido"); return; }

  // preparar UI
  $btn.disabled = true; $cancel.disabled = true; $log.style.display = "none"; $log.textContent = "";
  resetBars(); setStatus("Preparando…");

  // FormData
  const fd = new FormData();
  fd.append("test_kmz", f, f.name);

  xhr = new XMLHttpRequest();
  xhr.open("POST", `${RUN_URL.replace(/\/+$/,'')}/process`);
  xhr.responseType = "blob";

  // --- progreso de subida
  xhr.upload.onprogress = (e) => {
    if (e.lengthComputable) {
      const pct = Math.round((e.loaded / e.total) * 100);
      upBar.style.width = `${pct}%`; upPct.textContent = `${pct}%`;
    }
  };

  xhr.onloadstart = () => {
    // cuando la subida termina y empieza la espera en servidor
    procBar.style.display = "block"; // indeterminado visible
    $cancel.disabled = false;
    setStatus("Procesando en servidor…");
  };

  // --- progreso de descarga (si hay Content-Length)
  xhr.onprogress = (e) => {
    if (e.lengthComputable) {
      const pct = Math.round((e.loaded / e.total) * 100);
      downBar.style.width = `${pct}%`; downPct.textContent = `${pct}%`;
    }
  };

  xhr.onerror = () => setError("Error de red (fetch/XHR). ¿CORS? ¿conexión?");
  xhr.onabort = () => setStatus("Operación cancelada por el usuario.");
  xhr.onreadystatechange = () => {
    // si el servidor envía error 4xx/5xx, leer texto y mostrar log
    if (xhr.readyState === 4) {
      $cancel.disabled = true; $btn.disabled = false; procBar.style.display = "none";
      if (xhr.status >= 200 && xhr.status < 300) {
        // Descargar blob
        let filename = "Exportado.kmz";
        try {
          const cd = xhr.getResponseHeader("Content-Disposition") || "";
          const m = cd.match(/filename="?([^"]+)"?/i);
          if (m) filename = m[1];
        } catch {}
        const blob = xhr.response;
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
        setStatus("✅ Listo. Archivo descargado.");
        downBar.style.width = "100%"; downPct.textContent = "100%";
      } else {
        // Intentar leer el cuerpo como texto (el backend envía logs en el body)
        const reader = new FileReader();
        reader.onload = () => setError(`HTTP ${xhr.status} ${xhr.statusText}`, reader.result || "");
        reader.onerror = () => setError(`HTTP ${xhr.status} ${xhr.statusText}`);
        try { reader.readAsText(xhr.response); } catch { setError(`HTTP ${xhr.status} ${xhr.statusText}`); }
      }
    }
  };

  xhr.send(fd);
};
</script>
</body>
</html>
