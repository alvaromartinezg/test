<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BITEL KMZ extractor for informative letters</title>

  <!-- Pequeñas optimizaciones de red -->
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://unpkg.com">

  <style>
    :root{
      --bitel-yellow:#FFF200;
      --bitel-cyan:#00B8EB;
      --bitel-teal:#008D97;
      --bitel-deep:#003E4F;
      --ui-bg:#F5F7F9;
      --ui-text:#3A3A3A;
      --radius-xl:20px;
      --radius:12px;
      --shadow-lg:0 18px 60px rgba(0,0,0,.25);
      --shadow-md:0 8px 24px rgba(0,0,0,.08);
      --focus:0 0 0 3px rgba(0,184,235,.35);

      --muted:#667085;
    }
    *{ box-sizing: border-box; }
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
      margin:0;
      background:var(--bitel-deep);
      color:#111827;
    }

    /* Página contenedor */
    .page{
      background:var(--ui-bg);
      max-width: 1180px;
      min-height: 100vh;
      margin:18px auto;
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-lg);
      padding:0 20px 32px;
    }

    /* Hero */
    .hero{
      background:var(--bitel-yellow);
      border-radius:var(--radius-xl) var(--radius-xl) 0 0;
      padding:26px 16px 20px;
      text-align:center;
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .hero .logo{
      height:76px; width:auto; display:block; margin:0 auto 8px;
    }
    .hero h1{
      margin:8px 0 0; font-weight:800;
      color:var(--bitel-deep);
      font-size:clamp(22px,2.6vw,28px);
    }
    .hero p{
      margin:8px 0 0; color:#003244;
      font-size:14px;
    }

    /* Barra de acciones */
    .bar{
      display:flex; gap:12px; justify-content:center; flex-wrap:wrap; padding:18px;
    }
    .btn{
      background:#0E4051; color:#E8FBFF; border:none;
      border-radius:var(--radius);
      padding:12px 16px; font-weight:600; cursor:pointer;
      box-shadow:0 2px 8px rgba(0,0,0,.12);
      transition: background .15s ease, transform .04s ease, box-shadow .2s ease;
    }
    .btn:hover{ background: var(--bitel-teal); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn.accent{
      background:var(--bitel-cyan);
      color:#003244;
      box-shadow:0 4px 14px rgba(0,184,235,.25);
      font-weight:700;
    }
    .btn.accent:hover{ background:var(--bitel-teal); color:#fff; }
    .btn.danger{ background:#dc2626; color:#fff; }
    .btn.secondary{ background:#6b7280; color:#fff; }

    /* Tarjetas */
    .card{
      background:#fff; border-radius:14px;
      box-shadow:var(--shadow-md);
      border:1px solid rgba(0,0,0,.06);
      width:min(1100px,92vw); margin:0 auto 18px; padding:16px;
    }

    /* Inputs */
    .pill{
      background:#eef2f5; padding:6px 10px; border-radius:999px; font-size:12px;
      display:flex; align-items:center; gap:8px;
    }
    input[type="file"]{
      display:block; max-width:100%;
      padding:10px 12px;
      border:1.5px solid rgba(0,0,0,.14);
      border-radius:12px; background:#fff;
    }
    input[type="file"]:focus{
      outline:none; border-color:var(--bitel-cyan); box-shadow:var(--focus);
    }

    /* Estado */
    .status{
      font-size:12px; color:#374151; display:grid; grid-auto-flow:column; gap:18px; width:max-content;
    }
    .muted{ color:#6b7280; }
    .ok{ color:#059669; }
    .bad{ color:#dc2626; }

    /* Barras de progreso (tema) */
    .progress{
      position:relative; height:12px; background:#eef0f3;
      border-radius:999px; overflow:hidden;
      border:1px solid #e5e7eb;
      box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
    }
    .barline{ height:100%; width:0%; background:var(--bitel-cyan); transition: width .15s ease; }
    .barline.indeterminate{
      position:absolute; width:40%; left:-40%;
      animation: ind 1.1s infinite linear;
      background:linear-gradient(90deg, rgba(0,184,235,.25), rgba(0,184,235,.9), rgba(0,184,235,.25));
    }
    @keyframes ind { from{ left:-40% } to{ left:100% } }

    /* Log */
    pre{
      background:#fbfbfd; border:1px solid #eee; border-radius:10px; padding:10px; overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
    }

    /* Overlay de carga (opcional para UX) */
    #loadingOverlay{
      position:fixed; inset:0; background:rgba(255,255,255,.75);
      display:none; align-items:center; justify-content:center; z-index:9999; backdrop-filter: blur(2px);
    }
    #loadingOverlay .loader{
      width:48px; height:48px; border:4px solid #e5e7eb; border-top-color:var(--bitel-cyan);
      border-radius:50%; animation: spin .8s linear infinite; box-shadow:0 2px 8px rgba(0,0,0,.08);
    }
    #loadingOverlay .loader-text{ margin-top:12px; font-weight:600; color:#0E4051; text-align:center; }
    @keyframes spin { to{ transform: rotate(360deg); } }

    /* Filas */
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  </style>
</head>
<body>
  <div class="page">
    <!-- Overlay (no bloqueante, lo usamos solo para percepción de “procesando…”) -->
    <div id="loadingOverlay" aria-hidden="true">
      <div>
        <div class="loader"></div>
        <div class="loader-text">Procesando en servidor…</div>
      </div>
    </div>

    <!-- Hero -->
    <header class="hero">
      <img src="bitel_logo.png" class="logo" alt="bitel">
      <h1>KMZ extractor for Informative Letters</h1>
      <p>Sube un archivo <b>KMZ/KML</b> con polígonos o líneas. Se exportará el área de impacto en KMZ para responder cartas informativas.</p>
    </header>

    <!-- Barra principal -->
    <div class="bar">
      <label class="pill">
        Archivo:
        <input id="file" type="file" accept=".kmz,.kml" />
      </label>
      <button id="btn" class="btn accent">Procesar</button>
      <button id="cancel" class="btn danger" disabled>Cancelar</button>
    </div>

    <!-- Card: Progresos y estado -->
    <div class="card">
      <div class="row" style="gap:20px; align-items:flex-end; flex-wrap:wrap;">
        <div style="flex:1 1 260px; min-width:260px;">
          <div class="muted">Subiendo: <b><span id="upPct">0%</span></b></div>
          <div class="progress"><div id="upBar" class="barline"></div></div>
        </div>

        <div style="flex:1 1 260px; min-width:260px;">
          <div class="muted">Procesando en servidor:</div>
          <div class="progress"><div id="procBar" class="barline indeterminate" style="display:none;"></div></div>
        </div>

        <div style="flex:1 1 260px; min-width:260px;">
          <div class="muted">Descargando: <b><span id="downPct">0%</span></b></div>
          <div class="progress"><div id="downBar" class="barline"></div></div>
        </div>
      </div>

      <div id="status" class="muted" style="margin-top:10px;"></div>
      <pre id="log" class="mt8" style="display:none"></pre>
    </div>
  </div>

  <script>
  // ======= CONFIG =======
  const RUN_URL = "https://kmz-processor-411960240345.us-central1.run.app";

  // ======= DOM refs =======
  const $file   = document.getElementById("file");
  const $btn    = document.getElementById("btn");
  const $cancel = document.getElementById("cancel");
  const $status = document.getElementById("status");
  const $log    = document.getElementById("log");

  const upBar  = document.getElementById("upBar");
  const procBar= document.getElementById("procBar");
  const downBar= document.getElementById("downBar");
  const upPct  = document.getElementById("upPct");
  const downPct= document.getElementById("downPct");

  const overlay = document.getElementById("loadingOverlay");

  let xhr = null;

  function showOverlay(){ if (overlay) overlay.style.display = "flex"; }
  function hideOverlay(){ if (overlay) overlay.style.display = "none"; }

  function resetBars(){
    upBar.style.width = "0%";   upPct.textContent   = "0%";
    downBar.style.width = "0%"; downPct.textContent = "0%";
    procBar.style.display = "none";
  }
  resetBars();

  function setStatus(msg){ $status.textContent = msg; }
  function setError(msg, details=""){
    $status.textContent = "❌ " + msg;
    if(details){
      $log.style.display = "block";
      $log.textContent = details;
    }
  }

  $cancel.onclick = () => {
    if (xhr){
      xhr.abort();
      setStatus("Operación cancelada.");
      $cancel.disabled = true;
      $btn.disabled = false;
      hideOverlay();
      procBar.style.display = "none";
    }
  };

  $btn.onclick = () => {
    const f = $file.files[0];
    if(!f){ alert("Selecciona un archivo .kmz o .kml"); return; }
    if(!/\.(kmz|kml)$/i.test(f.name)){ alert("Archivo inválido"); return; }

    // preparar UI
    $btn.disabled = true; $cancel.disabled = true;
    $log.style.display = "none"; $log.textContent = "";
    resetBars(); setStatus("Preparando…");

    // FormData
    const fd = new FormData();
    fd.append("test_kmz", f, f.name);

    xhr = new XMLHttpRequest();
    xhr.open("POST", `${RUN_URL.replace(/\/+$/,'')}/process`);
    xhr.responseType = "blob";

    // progreso de subida
    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        upBar.style.width = `${pct}%`; upPct.textContent = `${pct}%`;
      }
    };

    xhr.onloadstart = () => {
      procBar.style.display = "block"; // indeterminado visible
      $cancel.disabled = false;
      showOverlay();
      setStatus("Procesando en servidor…");
    };

    // progreso de descarga (si hay Content-Length)
    xhr.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        downBar.style.width = `${pct}%`; downPct.textContent = `${pct}%`;
      }
    };

    xhr.onerror = () => {
      hideOverlay();
      procBar.style.display = "none";
      setError("Error de red (fetch/XHR). ¿CORS? ¿conexión?");
      $cancel.disabled = true; $btn.disabled = false;
    };
    xhr.onabort = () => {
      hideOverlay();
      setStatus("Operación cancelada por el usuario.");
    };

    xhr.onreadystatechange = () => {
      if (xhr.readyState === 4) {
        hideOverlay();
        $cancel.disabled = true; $btn.disabled = false;
        procBar.style.display = "none";

        if (xhr.status >= 200 && xhr.status < 300) {
          // Descargar blob
          let filename = "Exportado.kmz";
          try {
            const cd = xhr.getResponseHeader("Content-Disposition") || "";
            const m = cd.match(/filename="?([^"]+)"?/i);
            if (m) filename = m[1];
          } catch {}
          const blob = xhr.response;
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = filename;
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          setStatus("✅ Listo. Archivo descargado.");
          downBar.style.width = "100%"; downPct.textContent = "100%";
        } else {
          // Intentar leer el cuerpo como texto (el backend envía logs en el body)
          const reader = new FileReader();
          reader.onload = () => setError(`HTTP ${xhr.status} ${xhr.statusText}`, reader.result || "");
          reader.onerror = () => setError(`HTTP ${xhr.status} ${xhr.statusText}`);
          try { reader.readAsText(xhr.response); } catch { setError(`HTTP ${xhr.status} ${xhr.statusText}`); }
        }
      }
    };

    xhr.send(fd);
  };
  </script>
</body>
</html>
