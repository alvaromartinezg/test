<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KMZ Processor</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 720px; margin: 40px auto; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; }
    button { padding: 10px 16px; border-radius: 8px; border: 0; cursor: pointer; }
    .primary { background:#0b57d0; color:white; }
    .muted { color:#666; font-size:14px; }
    #status { margin-top: 8px; }
  </style>
</head>
<body>
  <h1>KMZ Processor</h1>
  <div class="card">
    <p>Sube tu <b>TEST.kmz</b> (o <b>TEST.kml</b>) y recibirás <b>Exportado.kmz</b>.</p>
    <input id="file" type="file" accept=".kmz,.kml" />
    <br><br>
    <button id="btn" class="primary">Procesar</button>
    <div id="status" class="muted"></div>
  </div>

  <script>
    const RUN_URL = "https://kmz-processor-411960240345.us-central1.run.app"; // tu backend
    const $file = document.getElementById("file");
    const $btn  = document.getElementById("btn");
    const $status = document.getElementById("status");

    function setStatus(msg) { $status.textContent = msg; }

    $btn.onclick = async () => {
      try {
        const f = $file.files[0];
        if (!f) { alert("Selecciona un archivo .kmz o .kml"); return; }
        if (!/\.(kmz|kml)$/i.test(f.name)) { alert("Archivo inválido"); return; }

        setStatus("Subiendo y procesando…");
        $btn.disabled = true;

        const fd = new FormData();
        fd.append("test_kmz", f, f.name);

        const res = await fetch(`${RUN_URL}/process`, {
          method: "POST",
          body: fd
        });

        if (!res.ok) {
          const txt = await res.text().catch(()=> "");
          throw new Error(`Error ${res.status}: ${txt || res.statusText}`);
        }

        // Obtener nombre de archivo desde Content-Disposition (si viene)
        const cd = res.headers.get("Content-Disposition") || "";
        const match = cd.match(/filename="?([^"]+)"?/i);
        const filename = match ? match[1] : "Exportado.kmz";

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        // Disparar descarga
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        setStatus("Listo ✅ Archivo descargado.");
      } catch (err) {
        console.error(err);
        setStatus("Falló: " + (err?.message || err));
        alert("Ocurrió un error.\n" + (err?.message || err));
      } finally {
        $btn.disabled = false;
      }
    };
  </script>
</body>
</html>
